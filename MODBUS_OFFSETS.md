# Таблица оффсетов Modbus регистров для сквозной адресации

## Принцип адресации

Каждое устройство занимает **20 регистров** в каждом типе регистров:
- **ШУК1** (Unit ID 1): адреса **0-19**
- **ШУК2** (Unit ID 2): адреса **20-39**
- **ШУК3** (Unit ID 3): адреса **40-59**
- **ШУК4** (Unit ID 4): адреса **60-79**
- ... и так далее

**Формула расчета оффсета:**
```
offset = (unitId - 1) * 20
```

---

## INPUT_REGISTERS (FC04 - Read Input Registers)

### Структура для одного устройства (адреса 0-9):

| Адрес (относительный) | Название | Тип | Описание | Масштаб |
|----------------------|---------|-----|----------|---------|
| 0 | CURRENT_TEMP | INT16 | Текущая температура | x10 |
| 1 | CURRENT_FAN_SPEED | UINT16 | Скорость вентилятора (0-1000) | - |
| 2 | VALVE_STATE | UINT16 | Состояние клапана (0=закрыт, 1=открыт) | - |
| 3 | PID_OUTPUT | INT16 | Выход PID регулятора | x10 |
| 4 | STATUS_WORD | UINT16 | Статусное слово (биты 0-7) | - |
| 5-9 | RESERVED | - | Резерв | - |

### Оффсеты для устройств:

| Device ID | Unit ID | INPUT_REGISTERS адреса | Оффсет | Температура (адрес) |
|-----------|---------|----------------------|--------|-------------------|
| ШУК1 | 1 | 0-9 | 0 | 0 |
| ШУК2 | 2 | 20-29 | 20 | 20 |
| ШУК3 | 3 | 40-49 | 40 | 40 |
| ШУК4 | 4 | 60-69 | 60 | 60 |
| ШУК5 | 5 | 80-89 | 80 | 80 |
| ШУК6 | 6 | 100-109 | 100 | 100 |
| ШУК7 | 7 | 120-129 | 120 | 120 |
| ШУК8 | 8 | 140-149 | 140 | 140 |
| ШУК9 | 9 | 160-169 | 160 | 160 |
| ШУК10 | 10 | 180-189 | 180 | 180 |
| ... | ... | ... | ... | ... |
| ШУК20 | 20 | 380-389 | 380 | 380 |

**Пример:**
- Чтобы прочитать температуру ШУК2, нужно прочитать INPUT_REGISTER адрес **20**
- Чтобы прочитать статусное слово ШУК2, нужно прочитать INPUT_REGISTER адрес **24**

---

## HOLDING_REGISTERS (FC03/FC06/FC16 - Read/Write Holding Registers)

### Структура для одного устройства (адреса 0-29):

| Адрес (относительный) | Название | Тип | Описание | Доступ | Масштаб |
|----------------------|---------|-----|----------|--------|---------|
| 0 | SETPOINT_TEMP | INT16 | Уставка температуры | RW | x10 |
| 1 | HYSTERESIS | UINT16 | Гистерезис | RW | x10 |
| 2 | TEMP_LOW | INT16 | Нижняя граница температуры | RW | x10 |
| 3 | TEMP_HIGH | INT16 | Верхняя граница температуры | RW | x10 |
| 4 | TEMP_FREEZE_LIMIT | INT16 | Защита от замерзания | RW | x10 |
| 5 | TEMP_OVERHEAT_LIMIT | INT16 | Защита от перегрева | RW | x10 |
| 6-9 | RESERVED | - | Резерв | - | - |
| 10 | COMMAND | UINT16 | Команда управления (битовое слово) | W | - |
| 11-12 | COMMAND_PARAM | UINT16 | Параметры команды (не используются) | W | - |
| 13-19 | RESERVED | - | Резерв | - | - |
| 20-24 | DEVICE_NAME | STRING | Имя устройства (5 регистров = 10 байт) | R | - |
| 25-29 | RESERVED | - | Резерв | - | - |

### Оффсеты для устройств:

| Device ID | Unit ID | HOLDING_REGISTERS адреса | Оффсет | Уставка (адрес) | Команда (адрес) |
|-----------|---------|-------------------------|--------|----------------|----------------|
| ШУК1 | 1 | 0-29 | 0 | 0 | 10 |
| ШУК2 | 2 | 30-59 | 30 | 30 | 40 |
| ШУК3 | 3 | 60-89 | 60 | 60 | 70 |
| ШУК4 | 4 | 90-119 | 90 | 90 | 100 |
| ШУК5 | 5 | 120-149 | 120 | 120 | 130 |
| ШУК6 | 6 | 150-179 | 150 | 150 | 160 |
| ШУК7 | 7 | 180-209 | 180 | 180 | 190 |
| ШУК8 | 8 | 210-239 | 210 | 210 | 220 |
| ШУК9 | 9 | 240-269 | 240 | 240 | 250 |
| ШУК10 | 10 | 270-299 | 270 | 270 | 280 |
| ... | ... | ... | ... | ... | ... |
| ШУК20 | 20 | 570-599 | 570 | 570 | 580 |

**Пример:**
- Чтобы записать уставку температуры для ШУК2 (например, 22.5°C = 225), нужно записать в HOLDING_REGISTER адрес **30** значение **225**
- Чтобы включить автоуправление для ШУК2, нужно записать в HOLDING_REGISTER адрес **40** значение **2** (бит 1)

---

## DISCRETE_INPUTS (FC02 - Read Discrete Inputs)

### Структура для одного устройства:

| Бит | Название | Описание |
|-----|----------|----------|
| 0 | IS_ONLINE | Устройство в сети |
| 1 | IS_WORKING | Система работает |
| 2 | IS_EMERGENCY_STOP | Аварийная остановка |
| 3 | TEMP_SENSOR_ERROR | Ошибка датчика температуры |
| 4 | PID_ACTIVE | PID регулятор активен |
| 5 | FREEZE_PROTECTION | Защита от замерзания активна |
| 6 | OVERHEAT_PROTECTION | Защита от перегрева активна |
| 7 | VALVE_OPEN | Клапан открыт |
| 8-15 | RESERVED | Резерв |

### Оффсеты для устройств:

| Device ID | Unit ID | DISCRETE_INPUTS адреса | Оффсет |
|-----------|---------|----------------------|--------|
| ШУК1 | 1 | 0-15 | 0 |
| ШУК2 | 2 | 16-31 | 16 |
| ШУК3 | 3 | 32-47 | 32 |
| ШУК4 | 4 | 48-63 | 48 |
| ... | ... | ... | ... |
| ШУК20 | 20 | 304-319 | 304 |

**Пример:**
- Чтобы прочитать бит IS_ONLINE для ШУК2, нужно прочитать DISCRETE_INPUT адрес **16** (бит 0)
- Чтобы прочитать бит VALVE_OPEN для ШУК2, нужно прочитать DISCRETE_INPUT адрес **23** (бит 7)

---

## COILS (FC01/FC05/FC15 - Read/Write Coils)

### Структура для одного устройства:

| Адрес (относительный) | Название | Описание | Доступ |
|----------------------|---------|----------|--------|
| 0 | MANUAL_MODE | Ручной режим | RW |
| 1 | ENABLE | Включить систему | RW |
| 2-15 | RESERVED | Резерв | - |

### Оффсеты для устройств:

| Device ID | Unit ID | COILS адреса | Оффсет |
|-----------|---------|-------------|--------|
| ШУК1 | 1 | 0-15 | 0 |
| ШУК2 | 2 | 16-31 | 16 |
| ШУК3 | 3 | 32-47 | 32 |
| ШУК4 | 4 | 48-63 | 48 |
| ... | ... | ... | ... |
| ШУК20 | 20 | 304-319 | 304 |

---

## Формулы расчета оффсетов

### INPUT_REGISTERS:
```typescript
offset = (unitId - 1) * 20;
actualAddress = offset + relativeAddress;
// Пример для ШУК2 (unitId=2), температура (relativeAddress=0):
// offset = (2-1) * 20 = 20
// actualAddress = 20 + 0 = 20
```

### HOLDING_REGISTERS:
```typescript
offset = (unitId - 1) * 30;
actualAddress = offset + relativeAddress;
// Пример для ШУК2 (unitId=2), уставка (relativeAddress=0):
// offset = (2-1) * 30 = 30
// actualAddress = 30 + 0 = 30
```

### DISCRETE_INPUTS:
```typescript
offset = (unitId - 1) * 16;
actualAddress = offset + relativeAddress;
// Пример для ШУК2 (unitId=2), IS_ONLINE (relativeAddress=0):
// offset = (2-1) * 16 = 16
// actualAddress = 16 + 0 = 16
```

### COILS:
```typescript
offset = (unitId - 1) * 16;
actualAddress = offset + relativeAddress;
// Пример для ШУК2 (unitId=2), ENABLE (relativeAddress=1):
// offset = (2-1) * 16 = 16
// actualAddress = 16 + 1 = 17
```

---

## Важные замечания

1. **INPUT_REGISTERS и HOLDING_REGISTERS используют разные размеры:**
   - INPUT_REGISTERS: 10 регистров на устройство → оффсет = (unitId-1) * 10, но для сквозной адресации используем (unitId-1) * 20
   - HOLDING_REGISTERS: 30 регистров на устройство → оффсет = (unitId-1) * 30

2. **HOLDING_REGISTERS:**
   - Для сквозной адресации HOLDING_REGISTERS лучше использовать оффсет 30 (а не 20), так как там используется до 30 регистров (включая DEVICE_NAME)

3. **Проверка:**
   - Максимальное количество устройств: 20
   - INPUT_REGISTERS: последний адрес = 19 * 20 + 9 = 389
   - HOLDING_REGISTERS: последний адрес = 19 * 30 + 29 = 599

---

## Реализация

При обработке запроса от OPC сервера:
1. Получаем Unit ID из запроса
2. Вычисляем оффсет по формуле
3. Преобразуем адрес из запроса: `actualAddress = offset + requestAddress`
4. Читаем/записываем данные из memoryManager с использованием actualAddress

